const { clienteModel } = require('../models/clienteModel');

const clienteController = {
    /**
  *Retorna os clientes cadastrados
  * @async
  * @function selecionaTodos: exibe todos os clientes cadastrados
  * @param {Request} req Objeto da requisição HTTP
  * @param {Response} res Objeto da resposta HTTP
  * @returns
  */
    selecionaTodos: async (req, res) => {
        try {
            const resultado = await clienteModel.selectClientes();
            // Verifica se a consulta possui clientes cadastrados, se não tiver ele retorna que não foi encontrado
            if (resultado.length === 0) {
                return res.status(200).json({ message: 'A consulta não retornou resultados' });
            }
            return res.status(200).json({ data: resultado });
        } catch (error) {
            console.error(error);
            res.status(500).json({ message: 'Ocorreu um erro no servidor', errorMessage: error.message });
        }
    },

    /**
 * Insere o registro dos clientes
 * @async
 * @function incluiRegistroCliente: cria o registro do cliente
 * @param {Request} req Objeto da requisição HTTP
 * @param {Response} res Objeto da resposta HTTP
 * @returns
 */
    incluiRegistroCliente: async (req, res) => {
        try {
            const { nome, cpf, email, telefone_cliente, numero, complemento, cep } = req.body;

            // Verifica se os campos abaixo possui valor
            if (!nome || !cpf || !email || !telefone_cliente || !cep || isNaN(cpf) || isNaN(telefone_cliente) || isNaN(numero) || isNaN(cep)) {
                return res.status(400).json({ message: 'Verifique os dados enviados e tente novamente' });
            }

            if (cep.length !== 8) {
                return res.status(400)({ message: "O CEP deve conter 8 dígitos." });
            }

            if (cpf.length !== 11) {
                return res.status(400)({ message: "O CPF deve conter 11 dígitos." });
            }
            const cpfAtual = await clienteModel.selectByCpf(cpf);
            if (cpfAtual.length === 1) {
                return res.status(409).json({ message: 'O CPF já existe!' });
            }
            const emailAtual = await clienteModel.selectByEmail(email);
            if (emailAtual.length === 1) {
                return res.status(409).json({ message: 'O email já existe!' });
            }
            const telefoneAtual = await clienteModel.selectByTelefone(telefone_cliente);
            if (telefoneAtual.length === 1) {
                return res.status(409).json({ message: 'O telefone já existe!' });
            }

            const respostaCliente = await clienteModel.insertCliente(nome, email, cpf);
            const id_cliente = respostaCliente.insertId

            // Busca o endereço pela API via CEP, de acordo com os parametros .
            const resposta = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const dados = await resposta.json();

            const { logradouro, bairro, localidade, uf } = dados;

            // Insere os dados na tabela telefones
            await clienteModel.insertTelefone(telefone_cliente, id_cliente);


            // Insere os dados na tabela endereços
            await clienteModel.insertEndereco(
                cep,
                uf,
                localidade,
                logradouro,
                bairro,
                numero,
                complemento,
                id_cliente
            );
            // Verifica se ocorreu um erro na hora de inserir os dados dos clientes
            if (id_cliente.insertId === 0) {
                throw new Error("Ocorreu um erro ao incluir o cliente");
            }

            res.status(201).json({ message: 'Registro incluído com sucesso!' });

        } catch (error) {
            console.error(error);
            res.status(500).json({ message: 'Ocorreu um erro no servidor', errorMessage: error.message });
        }
    },

    /**
     * Altera os dados dos clientes
     * @async
     * @function alterarCliente: altera os dados dos clientes
     * @param {Request} req Objeto da requisição HTTP
     * @param {Response} res Objeto da resposta HTTP
     * @returns 
     */
    alterarCliente: async (req, res) => {
        try {
            const id_cliente = Number(req.params.id_cliente);
            const { nome, cpf, email, telefone_cliente, numero, complemento, cep } = req.body;

            if (
                !id_cliente ||
                (!cpf && !email && !telefone_cliente && !numero && !complemento && !cep && !nome) ||
                typeof id_cliente !== 'number' || Number.isNaN(id_cliente)
            ) {
                return res.status(400).json({ message: 'Verifique os dados enviados e tente novamente' });
            }
            // Verifica se o cpf já existe no banco e assim nos notificará 
            if (cpf) {
                const cpfAtual = await clienteModel.selectByCpf(cpf);
                if (cpfAtual.length === 1) {
                    return res.status(409).json({ message: 'O CPF já existe!' });
                }
            }

            // Verifica se o email já existe no banco e assim nos notificará 
            if (email) {
                const emailAtual = await clienteModel.selectByEmail(email);
                if (emailAtual.length === 1) {
                    return res.status(409).json({ message: 'O email já existe!' });
                }
            }

            // Verifica se o telefone já existe no banco e assim nos notificará 
            if (telefone_cliente) {
                const telefoneAtual = await clienteModel.selectByTelefone(telefone_cliente);
                if (telefoneAtual.length === 1) {
                    return res.status(409).json({ message: 'O telefone já existe!' });
                }
            }

            // Seleção dos dados atuais
            const clienteAtual = await clienteModel.selectByIdClientes(id_cliente);
            const clienteAtualTelefones = await clienteModel.selectByIdTelefones(id_cliente);
            const clienteAtualEnderecos = await clienteModel.selectByIdEnderecos(id_cliente);

            if (clienteAtual.length === 0 || clienteAtualTelefones.length === 0 || clienteAtualEnderecos.length === 0) {
                return res.status(200).json({ message: 'Cliente não localizado' });
            }

            // Atribuição correta dos novos valores
            // Verifica se o valor que vai ser alterado é o mesmo que foi atribuido na tabela, caso seja ele não modifica o valor.
            // Se ele não for o mesmo ele só vai alterar o valor escolhido e restante dos valores irão permanecer os mesmos
            const novoNome = nome ?? clienteAtual[0].nome_cliente;
            const novoCpf = cpf ?? clienteAtual[0].cpf;
            const novoEmail = email ?? clienteAtual[0].email;
            const novoTelefone = telefone_cliente ?? clienteAtualTelefones[0].telefone_cliente;
            const novoNumero = numero ?? clienteAtualEnderecos[0].numero;
            const novoComplemento = complemento ?? clienteAtualEnderecos[0].complemento;
            const novoCep = cep ?? clienteAtualEnderecos[0].cep;

            // Atualizações
            const resultUpdateClientes = await clienteModel.updateClientes(novoNome, novoCpf, novoEmail, id_cliente);
            const resultUpdateTelefones = await clienteModel.updateTelefones(id_cliente, novoTelefone);
            const resultUpdateEnderecos = await clienteModel.updateEnderecos(id_cliente, novoNumero, novoComplemento, novoCep);

            // Caso não haja mudanças
            if (
                (resultUpdateClientes.affectedRows === 1 && resultUpdateClientes.changedRows === 0) &&
                (resultUpdateTelefones.affectedRows === 1 && resultUpdateTelefones.changedRows === 0) &&
                (resultUpdateEnderecos.affectedRows === 1 && resultUpdateEnderecos.changedRows === 0)
            ) {
                return res.status(200).json({ message: 'Não há alterações a serem realizadas' });
            }

            // caso os dados forem corretamente inseridos, irá realizar as modificações que foram solicitadas
            return res.status(200).json({ message: 'Registro alterado com sucesso', data: resultUpdateClientes });

        } catch (error) {
            console.error(error);
            res.status(500).json({ message: 'Ocorreu um erro no servidor', errorMessage: error.message });
        }
    },

    /**
  * Exclui os dados dos clientes
  * @async
  * @function deletaCliente: deleta os dados dos clientes, da tabela: clientes, enderecos, telefones, pedidos e calculo_entregas
  * @param {Request} req Objeto da requisição HTTP
  * @param {Response} res Objeto da resposta HTTP
  * @returns 
  */
    deletaCliente: async (req, res) => {
        try {
            const id_cliente = Number(req.params.id_cliente);

            if (!id_cliente || !Number.isInteger(id_cliente)) {
                return res.status(400).json({ message: 'Forneça um identificador válido' });
            }

            const clienteSelecionado = await clienteModel.selectByIdClientes(id_cliente);
            if (clienteSelecionado.length === 0) {
                return res.status(200).json({ message: 'Cliente não localizado na base de dados' });
            }
            // Faz primeiro a exclusão do calculo, depois do pedido e após isso é feito as exclusões do telefone, endereço e do cliente
            await clienteModel.deleteCalculo(id_cliente)
            await clienteModel.deletePedidos(id_cliente);
            await clienteModel.deleteTelefones(id_cliente);
            await clienteModel.deleteEnderecos(id_cliente);

            const resultadoDelete = await clienteModel.deleteCliente(id_cliente);
            // Verifica se teve linhas afetadas, caso não teve nenhum linha foi afetada e irá retornar um erro. 
            // Se as linhas forem afetadas, o cliente foi excluído 
            if (resultadoDelete.affectedRows === 0) {
                return res.status(200).json({ message: 'Ocorreu um erro ao excluir o cliente' });
            }

            return res.status(200).json({ message: 'Cliente excluído com sucesso' });
        } catch (error) {
            console.error(error);
            res.status(500).json({ message: "Ocorreu um erro no servidor", errorMessage: error.message });
        }
    }

}

module.exports = { clienteController }
