const { clienteModel } = require('../models/clienteModel');

const clienteController = {
    incluiRegistroCliente: async (req, res) => {
        try {
            const { nome, cpf, email, telefone_cliente, numero, complemento, cep } = req.body;
            
            if (!nome || !cpf || !email || !telefone_cliente || !numero || !complemento || !cep) {
                return res.status(400).json({ message: 'Verifique os dados enviados e tente novamente' });
        
            }
            const emailAtual = await clienteModel.selectByEmail(email);
            if (emailAtual.length === 1) {
                return res.status(409).json({ message: 'O Email já existe!' });
            }

            const cpfAtual = await clienteModel.selectByCpf(cpf);
            if (cpfAtual.length === 1) {
                return res.status(409).json({ message: 'O CPF já existe!' });
            }
            const id_cliente = await clienteModel.insertCliente(nome, email, cpf);

            const resposta = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const dados = await resposta.json();

            const { logradouro, bairro, localidade, uf } = dados;

            await clienteModel.insertTelefone(telefone_cliente, id_cliente);

            await clienteModel.insertEndereco(
                cep,
                uf,
                localidade,
                logradouro,
                bairro,
                numero,
                complemento,
                id_cliente
            );

            res.status(201).json({ message: 'Registro incluído com sucesso!' });

        } catch (error) {
            console.error(error);
            res.status(500).json({ message: 'Ocorreu um erro no servidor', errorMessage: error.message });
        }
    }
}

module.exports = { clienteController }
